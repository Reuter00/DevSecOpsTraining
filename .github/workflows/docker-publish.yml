name: Build and publish container

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: ghcr.io/reuter00/devsecopstraining
  FRONTEND_IMAGE: ghcr.io/reuter00/devsecopstraining-frontend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:latest
            ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}

  redeploy:
    needs: build-and-push
    runs-on: [self-hosted, portainer]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Redeploy Portainer stack
        env:
          PORTAINER_URL: ${{ secrets.PORTAINER_URL }}
          PORTAINER_STACK_ID: ${{ secrets.PORTAINER_STACK_ID }}
          PORTAINER_ENDPOINT_ID: ${{ secrets.PORTAINER_ENDPOINT_ID }}
          PORTAINER_API_KEY: ${{ secrets.PORTAINER_API_KEY }}
          POSTGRES_HOST: postgres
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          PGADMIN_DEFAULT_EMAIL: ${{ secrets.PGADMIN_DEFAULT_EMAIL }}
          PGADMIN_DEFAULT_PASSWORD: ${{ secrets.PGADMIN_DEFAULT_PASSWORD }}
          GRAFANA_ADMIN_USER: ${{ secrets.GRAFANA_ADMIN_USER }}
          GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
          NODE_ENV: production
        run: |
          set -euo pipefail

          if [ -z "${PORTAINER_URL}" ] || [ -z "${PORTAINER_STACK_ID}" ] || [ -z "${PORTAINER_ENDPOINT_ID}" ] || [ -z "${PORTAINER_API_KEY}" ]; then
            echo "Missing one of the required secrets: PORTAINER_URL, PORTAINER_STACK_ID, PORTAINER_ENDPOINT_ID, PORTAINER_API_KEY" >&2
            exit 1
          fi

          if [ ! -f docker-compose.yml ]; then
            echo "docker-compose.yml not found; cannot redeploy" >&2
            exit 1
          fi

          DATA=$(python3 << 'PY'
          import json, os, pathlib

          content = pathlib.Path("docker-compose.yml").read_text()

          def env(name, default=""):
            val = os.environ.get(name, default)
            if val is None:
              val = ""
            return {"name": name, "value": val}

          env_list = [
            env("NODE_ENV", "production"),
            env("POSTGRES_HOST", "postgres"),
            env("POSTGRES_USER"),
            env("POSTGRES_PASSWORD"),
            env("POSTGRES_DB"),
            env("DATABASE_URL"),
            env("JWT_SECRET"),
            env("PGADMIN_DEFAULT_EMAIL"),
            env("PGADMIN_DEFAULT_PASSWORD"),
            env("GRAFANA_ADMIN_USER"),
            env("GRAFANA_ADMIN_PASSWORD"),
          ]

          payload = {
            "StackFileContent": content,
            "Prune": True,
            "PullImage": True,
            "Env": env_list,
          }

          print(json.dumps(payload))
          PY
          )

          STATUS=$(curl -k -s -o /tmp/portainer_resp.txt -w "%{http_code}" -X PUT \
            "${PORTAINER_URL}/api/stacks/${PORTAINER_STACK_ID}?endpointId=${PORTAINER_ENDPOINT_ID}" \
            -H "X-API-Key: ${PORTAINER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$DATA")

          echo "Portainer response (HTTP $STATUS):"
          cat /tmp/portainer_resp.txt
          echo

          if [ "$STATUS" -lt 200 ] || [ "$STATUS" -ge 300 ]; then
            echo "Redeploy failed (status $STATUS) for stack=${PORTAINER_STACK_ID} endpoint=${PORTAINER_ENDPOINT_ID}" >&2
            exit 1
          fi
